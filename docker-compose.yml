services:
  # ===========================================
  # LOAD BALANCER / API GATEWAY
  # ===========================================
  nginx:
    image: nginx:alpine
    container_name: api-gateway
    ports:
      - "80:80"
      - "8090:8090"  # Monitoring port
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - users-api-1
      - users-api-2
      - users-api-3
      - hotels-api
      - search-api
    networks:
      - app-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost/nginx-health"]
      interval: 10s
      timeout: 5s
      retries: 3

  # ===========================================
  # DATABASES
  # ===========================================
  mysql:
    image: mysql:8
    container_name: users-mysql
    ports:
      - "3307:3306"
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: users-api
    volumes:
      - mysql_data:/var/lib/mysql
    networks:
      - app-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5

  memcached:
    image: memcached:1.6-alpine
    container_name: users-memcached
    ports:
      - "11211:11211"
    networks:
      - app-network
    restart: unless-stopped

  mongo:
    image: mongo:6
    container_name: hotels-mongo
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: root
      MONGO_INITDB_ROOT_PASSWORD: root
    volumes:
      - mongo_data:/data/db
    networks:
      - app-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5

  rabbitmq:
    image: rabbitmq:3-management
    container_name: hotels-rabbit
    ports:
      - "5672:5672"
      - "15672:15672"
    environment:
      RABBITMQ_DEFAULT_USER: root
      RABBITMQ_DEFAULT_PASS: root
    networks:
      - app-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  solr:
    image: solr:9
    container_name: search-solr
    ports:
      - "8983:8983"
    volumes:
      - solr_data:/var/solr
      - ./search-api/internal/solr-config/conf:/opt/solr-config/conf:ro
    networks:
      - app-network
    restart: unless-stopped
    environment:
      - SOLR_HOME=/var/solr/data
      - SOLR_LOGS_DIR=/var/solr/logs
    entrypoint:
      - docker-entrypoint.sh
      - solr-precreate
      - hotels
      - /opt/solr-config
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8983/solr/hotels/admin/ping || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 15
      start_period: 90s

  # ===========================================
  # USERS API - 3 REPLICAS (Load Balanced)
  # ===========================================
  users-api-1:
    build:
      context: ./users-api
      dockerfile: Dockerfile
    image: users-api:latest
    container_name: users-api-1
    environment:
      MYSQL_HOST: mysql
      MYSQL_PORT: "3306"
      MYSQL_DATABASE: users-api
      MYSQL_USERNAME: root
      MYSQL_PASSWORD: root
      MEMCACHED_HOST: memcached
      MEMCACHED_PORT: "11211"
      JWT_SECRET: ThisIsAnExampleJWTKey!
      JWT_DURATION: "24h"
      CACHE_DURATION: "30s"
      PORT: "8082"
      INSTANCE_ID: "users-api-1"
    depends_on:
      mysql:
        condition: service_healthy
      memcached:
        condition: service_started
    networks:
      - app-network
    restart: unless-stopped

  users-api-2:
    build:
      context: ./users-api
      dockerfile: Dockerfile
    image: users-api:latest
    container_name: users-api-2
    environment:
      MYSQL_HOST: mysql
      MYSQL_PORT: "3306"
      MYSQL_DATABASE: users-api
      MYSQL_USERNAME: root
      MYSQL_PASSWORD: root
      MEMCACHED_HOST: memcached
      MEMCACHED_PORT: "11211"
      JWT_SECRET: ThisIsAnExampleJWTKey!
      JWT_DURATION: "24h"
      CACHE_DURATION: "30s"
      PORT: "8082"
      INSTANCE_ID: "users-api-2"
    depends_on:
      mysql:
        condition: service_healthy
      memcached:
        condition: service_started
    networks:
      - app-network
    restart: unless-stopped

  users-api-3:
    build:
      context: ./users-api
      dockerfile: Dockerfile
    image: users-api:latest
    container_name: users-api-3
    environment:
      MYSQL_HOST: mysql
      MYSQL_PORT: "3306"
      MYSQL_DATABASE: users-api
      MYSQL_USERNAME: root
      MYSQL_PASSWORD: root
      MEMCACHED_HOST: memcached
      MEMCACHED_PORT: "11211"
      JWT_SECRET: ThisIsAnExampleJWTKey!
      JWT_DURATION: "24h"
      CACHE_DURATION: "30s"
      PORT: "8082"
      INSTANCE_ID: "users-api-3"
    depends_on:
      mysql:
        condition: service_healthy
      memcached:
        condition: service_started
    networks:
      - app-network
    restart: unless-stopped

  # ===========================================
  # HOTELS API
  # ===========================================
  hotels-api:
    build:
      context: ./hotels-api
      dockerfile: dockerfile
    image: hotels-api:latest
    container_name: hotels-api-container
    environment:
      MONGO_HOST: mongo
      MONGO_PORT: "27017"
      MONGO_USERNAME: root
      MONGO_PASSWORD: root
      MONGO_DATABASE: hotels-api
      MONGO_COLLECTION_HOTELS: hotels
      MONGO_COLLECTION_RESERVATIONS: reservations
      CACHE_MAX_SIZE: "100000"
      CACHE_ITEMS_TO_PRUNE: "100"
      CACHE_DURATION: "30s"
      RABBIT_HOST: rabbitmq
      RABBIT_PORT: "5672"
      RABBIT_USERNAME: root
      RABBIT_PASSWORD: root
      RABBIT_QUEUE_NAME: hotels-news
      JWT_SECRET: ThisIsAnExampleJWTKey!
      PORT: "8081"
    depends_on:
      mongo:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - app-network
    restart: unless-stopped

  # ===========================================
  # SEARCH API
  # ===========================================
  search-api:
    build:
      context: ./search-api
      dockerfile: Dockerfile
    image: search-api:latest
    container_name: search-api-container
    environment:
      SOLR_HOST: solr
      SOLR_PORT: "8983"
      SOLR_COLLECTION: hotels
      RABBIT_HOST: rabbitmq
      RABBIT_PORT: "5672"
      RABBIT_USERNAME: root
      RABBIT_PASSWORD: root
      RABBIT_QUEUE_NAME: hotels-news
      HOTELS_API_HOST: hotels-api-container
      HOTELS_API_PORT: "8081"
      PORT: "8082"
    depends_on:
      solr:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      hotels-api:
        condition: service_started
    networks:
      - app-network
    restart: unless-stopped

networks:
  app-network:
    driver: bridge

volumes:
  mongo_data:
  mysql_data:
  solr_data:
